@using BAL
@using DAL
@{
    ViewBag.Title = "Delivery Status Report";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    string startdate = ViewData["StartDate"].ToString();
    string enddate = ViewData["EndDate"].ToString();
    string UniqueReferenceID = ViewData["UniqueReferenceID"] != null ? ViewData["UniqueReferenceID"].ToString() : "";
    string InvoiceNO = ViewData["InvoiceNO"] != null ? ViewData["InvoiceNO"].ToString() : "";
    List<SelectListItem> listItems = new List<SelectListItem>();
    listItems.Add(new SelectListItem { Text = "Invoice Level Delivery", Value = "1" });
    listItems.Add(new SelectListItem { Text = "Order Level Delivery", Value = "2" });
}

<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<div class="right_col" role="main">
    <!-- top tiles -->
    <div class="page-title">
        <div class="title_left">
            <h3>Delivery Status Report</h3>
        </div>
    </div>
    <!-- /top tiles -->
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_content">
                    <form id="demo-form" method="post" action="@Url.Action("DeliveryStatusReport","Report")">
                        @Html.AntiForgeryToken()
                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label for="FromDate">Store Order From Date</label>
                                <input type="date" value="@startdate" class="form-control" name="FromDate" id="FromDate" required />
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label for="enddate">Order To Date</label>
                                <input type="date" value="@enddate" class="form-control" name="ToDate" id="ToDate" required />
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label for="UniqueReferenceID">Unique Reference ID</label>
                                <input type="text" value="@UniqueReferenceID" class="form-control" name="UniqueReferenceID" id="UniqueReferenceID" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>City</label>
                                @Html.ListBox("SelectedLocations", (MultiSelectList)ViewBag.Locations, new { size = 4, @class = "form-control" })
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>DC</label>
                                @* @Html.DropDownList("SelectedDC", new SelectList(ViewBag.DCs, "Value", "Id", ViewBag.SelectedDCs), "Please select", new { @class = "form-control" })*@
                                @Html.ListBox("SelectedDC", (MultiSelectList)ViewBag.DCs, new { size = 4, @class = "form-control" })
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>Store Code</label>
                                @Html.ListBox("SelectedStores", (MultiSelectList)ViewBag.Stores, new { size = 4, @class = "form-control" })
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>SKU Category Type</label>
                                @Html.ListBox("SelectedTypes", (MultiSelectList)ViewBag.ItemTypes, new { size = 4, @class = "form-control" })
                                <p class="text text-danger" style="margin-top:5px;" id="SelectedTypesError"></p>
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>SKU Category</label>
                                @Html.ListBox("SelectedCategories", (MultiSelectList)ViewBag.ItemCategories, new { size = 4, @class = "form-control" })
                                <p class="text text-danger" style="margin-top:5px;" id="SelectedCategoriesError"></p>
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>SKU Code</label>
                                @Html.ListBox("SelectedSKUs", (MultiSelectList)ViewBag.Items, new { size = 4, @class = "form-control" })
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label>Report Type</label>
                                @Html.DropDownList("ReportType", listItems, new { @class = "form-control" })
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <label for="UniqueReferenceID">Invoice No</label>
                                <input type="text" value="@InvoiceNO" class="form-control" name="InvoiceNO" id="InvoiceNO" />
                            </div>
                            <div class="col-md-4 col-sm-4 col-xs-12">
                                <div class="form-group text-right">
                                    <br />
                                    <input type="submit" class="btn btn-default btn btn-success" style="margin-bottom:0px;" value="Search" />
                                    <input type="submit" value="Export to Excel" name="Edit" formaction="@Url.Action("DeliveryStatusReportExportExcel")" formmethod="post" class="btn btn-default" style="margin-bottom:0px;" />
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="x_panel">
                <div class="x_content">
                    <p class="text-muted font-13 m-b-30">
                        @*<strong id="title"> Name: Daily Sales Report</strong>*@
                        <br />
                        <span id="message" name="Message"> Store Order Date: From: @startdate To: @enddate</span>
                    </p>

                    <table id="datatable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                @if (ViewBag.ReportType != 1)
                                {
                                    <td>PO Numeber</td>
                                    <td>Unique Reference Id</td>
                                }
                                <td>Store Order Date</td>
                                <td>Dispatch Date</td>
                                <td>From DC</td>
                                <td>Store Code</td>
                                <td>Store Name</td>
                                <td>City</td>
                                <td>Invoice Number</td>
                                <td>Invoice Quantity</td>
                                <td>Delivery status</td>
                                <td>Remark</td>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewBag.FinalizedReports != null)
                            {
                                int i = 1;
                                foreach (DeliveryStatusReport head in ViewBag.FinalizedReports)
                                {
                                    <tr>
                                        @if (ViewBag.ReportType != 1)
                                        {
                                            <td>@head.PONumber</td>
                                            <td>@head.UniqueReferenceId</td>
                                        }
                                        <td>@(head.Store_Order_Date != null ? head.Store_Order_Date.Value.ToString("dd/MM/yyyy", System.Globalization.CultureInfo.InvariantCulture) : "")</td>
                                        <td>@(head.InvoiceDate.Replace("-", "/") )</td>
                                        <td>@head.DCName</td>
                                        <td>@head.StoreCode</td>
                                        <td>@head.StoreName</td>
                                        <td>@head.CityCode</td>
                                        <td>@head.InvoiceNumber</td>
                                        <td>@head.InvoiceQuantity</td>
                                        <td>@head.DeliveryStatus</td>
                                        <td>@head.Reason</td>
                                    </tr>
                                    i++;
                                }
                            }
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {

            $(".loader").hide();
            //t = $('#example').DataTable();
            var SessionCustomer = window.SessionCustomer != undefined ? window.SessionCustomer : "OYO";
            /**/
            var title = 'Name: Delivery Status Report';
            var titleText = 'Store Order Date: From: ' + convertDate($("#FromDate").val()) + ' To: ' + convertDate($("#ToDate").val()) + '';
            //$("#title").text(title);
            $("#message").text(titleText);
            /**/
            var table;
            table = $("#datatable").DataTable({
                responsive: true,
                "paging": false,
                "scrollY": '100vh',
                "scrollCollapse": true,
                dom: 'l<"toolbar">frtip',
            });
            $("div.toolbar").html('<b>TOTAL ROW COUNT: ' + table.rows().count() + '</b>');
           $('#SelectedLocations').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 150,
                enableFiltering: true
            });
            $('#SelectedDC').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                enableFiltering: true
            });
            $('#SelectedStores').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 150,
                enableFiltering: true
            });

            $('#SelectedTypes').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 150,
                enableFiltering: true
            });
            $('#SelectedCategories').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 150,
                enableFiltering: true
            });

            $('#SelectedSKUs').multiselect({
                includeSelectAllOption: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 150,
                enableFiltering: true
            });
            $("#SelectedLocations").change(function (){
            var SelectedLocations = $(this).val()
                $.ajax({
                    url: '@Url.Action("GetWareHouseDCForLocations", "Order")',
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        "SelectedLocations": SelectedLocations
                    },
                    success: function (result) {
                        $("#SelectedDC").html("");
                        var markup = "";
                        for (var x = 0; x < result.data.length; x++) {
                            markup += "<option value=" + result.data[x].Id + ">" + result.data[x].Name + "</option>";
                        }
                        $("#SelectedDC").html(markup);
                        $("#SelectedDC").multiselect('destroy');
                        $('#SelectedDC').multiselect({
                            includeSelectAllOption: true,
                            enableCaseInsensitiveFiltering: true,
                            buttonWidth: '100%',
                            maxHeight: 150,
                            enableFiltering: true
                        });
                        $("#SelectedDC").trigger("change");
                    },
                    error: function (reponse) {
                        alert("error : " + reponse)
                    },
                });
            });
            $("#SelectedDC").change(function () {
                var SelectedWareHouseDCs = $(this).val()
                $.ajax({
                    url: '@Url.Action("GetStoresForWareHouse", "Order")',
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        "SelectedWareHouseDCs": SelectedWareHouseDCs,
                        "OrderReport": "Report"
                    },
                    success: function (result) {
                        $("#SelectedStores").html("");
                        var markup = "";
                        for (var x = 0; x < result.data.length; x++) {
                            markup += "<option value=" + result.data[x].Id + ">" + result.data[x].StoreCode + "</option>";
                        }
                        $("#SelectedStores").html(markup);
                        $("#SelectedStores").multiselect('destroy');
                        $('#SelectedStores').multiselect({
                            includeSelectAllOption: true,
                            enableCaseInsensitiveFiltering: true,
                            buttonWidth: '100%',
                            maxHeight: 150,
                            enableFiltering: true
                        });
                    },
                    error: function (reponse) {
                        alert("error : " + reponse)
                    },
                });
            });

            $("#SelectedTypes").change(function () {
                var SelectedItemTypes = $(this).val()
                $.ajax({
                    url: '@Url.Action("GetCatgoriesForItemTypes", "Order")',
                    type: 'POST',
                    dataType: "JSON",
                    data: {
                        "SelectedItemTypes": SelectedItemTypes
                    },
                    success: function (result) {
                        $("#SelectedCategories").html("");
                        var markup = "";
                        for (var x = 0; x < result.data.length; x++) {
                            markup += "<option value=" + result.data[x].Id + ">" + result.data[x].CategoryName + "</option>";
                        }
                        $("#SelectedCategories").html(markup);
                        $("#SelectedCategories").multiselect('destroy');
                        $('#SelectedCategories').multiselect({
                            includeSelectAllOption: true,
                            enableCaseInsensitiveFiltering: true,
                            buttonWidth: '100%',
                            maxHeight: 150,
                            enableFiltering: true
                        });
                        $("#SelectedCategories").trigger("change");
                    },
                    error: function (reponse) {
                        alert("error : " + reponse)
                    },
                });
            });
            $("#SelectedCategories").change(function () {
            var SelectedCategories = $(this).val();
            var SelectedTypes = $("#SelectedTypes").val();
            $.ajax({
                url: '@Url.Action("GetItemsForSKUCategory", "Order")',
                type: 'POST',
                dataType: "JSON",
                data: {
                    "SelectedCategories": SelectedCategories,
                    "SelectedTypes": SelectedTypes,
                    "OrderReport":"Report"
                },
                success: function (result) {
                    $("#SelectedSKUs").html("");
                    var markup = "";
                    for (var x = 0; x < result.data.length; x++) {
                        markup += "<option value=" + result.data[x].Id + ">" + result.data[x].SKUCode + "</option>";
                    }
                    $("#SelectedSKUs").html(markup);
                    $("#SelectedSKUs").multiselect('destroy');
                    $('#SelectedSKUs').multiselect({
                        includeSelectAllOption: true,
                        enableCaseInsensitiveFiltering: true,
                        buttonWidth: '100%',
                        maxHeight: 150,
                        enableFiltering: true
                    });
                },
                error: function (reponse) {
                    alert("error : " + reponse)
                },
            });
        });
        });
        function convertDate(dateString) {
            var p = dateString.split(/\D/g)
            return [p[2], p[1], p[0]].join("-");
        }

        $('#demo-form').submit(function (e) {
            var FromDate = $("#FromDate").val();
            var ToDate = $("#ToDate").val();
            var date1 = new Date(FromDate);
            var date2 = new Date(ToDate);
            var datediffmill = date2 - date1;
            var datediff = datediffmill / (1000 * 60 * 60 * 24)
            if (datediff > 30) {
                alert("Search Date Limit Exceeded.\nPlease Select Date Range Between 30 Days");
                e.preventDefault();
            }
            else {
                return true;
            }
        });
    </script>
</div>